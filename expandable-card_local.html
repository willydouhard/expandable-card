<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html" >

<dom-module id="expandable-card">
<!--
`expandable-card` is a card that can expand (like you see on mobile native apps).

Example:

```html
<expandable-card
  retracted-title="Retracted title"
  retracted-content="Retracted content"
  expanded-title="Expanded title"
  expanded-content="Expanded content">
</expandable-card>
```

Its not really possible to think of all the usecase for this type of component.
Hence, you should really customize it to fit your needs.
Maybe you want another element of your card to be animated instead of the header while expanding,
or maybe you want to pass an image property for your card.
Dont be afraid to tweek this component as you want.

`expandable-card` by itself is not very useful, because you will probably want
to use more than one. To get multiple `expandable-card` that expands to fit a container
see [expandable-card-container](https://customelements.io/willydouhard/expandable-card-container/)

### Styling
The following custom properties and mixins are available for styling:
Custom property | Description | Default
----------------|-------------|----------
`--card-width` | Width of the card when retracted | `300px`
`--card-height` | Height of the card when retracted | `200px`
`--card-font-size` | Font size of the card | `3em`
`--card-color` | Card global color | `#000`
`--card-button-background-color` | paper-button background color | `#fff`
`--card-background-color` | Background color of the card | `#fff`
`--card-header-background-color` | Background color for the header when the card is expanded | `#607D8B`
`--card-header-color` | Header color | `#fff`
@demo demo/index.html
-->
	<template>
	<style>
	:host {
		display: block;
		position: relative;
		z-index: 1;
		width: var(--card-width, 300px);
		height: var(--card-height, 200px);
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--card-color, #000);
		font-family: 'Roboto';
		font-size: var(--card-font-size, 3em);
	}

	:host.host_expanded{
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width: auto;
		height: auto;
	}

	paper-button {
		background-color: var(--card-button-background-color, #fff);
		color: var(--card-color, #000);
	}

	paper-card{
		flex-grow: 1;
		display: flex;
		flex-direction: column;
		background-color: var(--card-background-color, #fff);
	}

	paper-card .header{
		color: var(--card-color, #000);
	}

	paper-card .card-content{
		flex-grow: 1;
	}

	paper-card .card-actions{
		text-align: right;
	}

	a:link {
		color: var(--card-color, #000);
		text-decoration: none;
	}

	/* visited link */
	a:visited {
		color: var(--card-color, #000);
		text-decoration: none;
	}

	/* mouse over link */
	a:hover {
		color: var(--card-color, #000);
		text-decoration: none;
	}

	/* selected link */
	a:active {
		color: var(--card-color, #000);
		text-decoration: none;
	}

	.container{
		font-size: 16px;
		position: relative;
		z-index: 2;
		width: 100%;
		height: 100%;
	}

	#retracted-content{
		opacity: 1;
		display: flex;
	}

	#expanded-content{
		opacity: 0;
		display: none;
		flex-direction: column;
	}

	#placeholder-content{
		position: absolute;
		top: 0;
		left: 0;
		z-index: 1;
		flex-direction: column;
		display: flex;
	}

	#placeholder-content__header{
		position: absolute;
		width: 100%;
	}

	#placeholder-content paper-card{
		will-change: transform;
	}

	.container__header{
		height: 70px;
		display: flex;
		color: var(--card-header-color, #fff);
		background-color: var(--card-header-background-color, #607D8B);
		justify-content: space-between;
		align-items: center;
	}

	.container__header__side {
		width: 40px;
	}

	#expanded-content__content{
		position: relative;
		flex-grow: 1;
		display: flex;
		justify-content: center;
		align-items: center;
		background-color: var(--card-background-color, #fff);
	}

	</style>

	<!-- Content displayed when retracted -->
	<div id="retracted-content" class="container">
		<paper-card heading="[[retractedTitle]]">
			<div class="card-content">{{retractedContent}}</div>
			<div class="card-actions">
					<paper-button on-tap="toggle" noink>Expand</paper-button>
			</div>
		</paper-card>
	</div>

	<!-- Content displayed while expanding -->
	<div id="placeholder-content" class="container">
		<div id="placeholder-content__header" class="container__header"></div>
		<paper-card id="placeholder-content__paper-card">
			<div class="card-content"></div>
		</paper-card>
	</div>

	<!-- Content displayed when expanded -->
	<div id="expanded-content" class="container">
		<div class="container__header">
				<paper-icon-button on-tap="toggle" class="container__header__side" noink icon="arrow-back"></paper-icon-button>
			<div>{{expandedTitle}}</div>
			<div class="container__header__side"></div>
		</div>
		<div id="expanded-content__content">{{expandedContent}}</div>
	</div>

</template>
<script>

Polymer({
	is: 'expandable-card',
	properties: {
            retractedTitle: {
                  type: String
            },
            retractedContent: {
                  type: String
            },
            expandedTitle: {
                  type: String
            },
            expandedContent: {
                  type: String
            },
		expanded: {
			type: Boolean,
			value: false
		},
		animating: {
			type: Boolean,
			value: false
		},
		EXPANDING_EVENT: {
			type: String,
			value: 'expanding',
			readOnly: true
		},
		RETRACTING_EVENT: {
			type: String,
			value: 'retracting',
			readOnly: true
		},
		contentAnimationOptions: {
			type: Object,
			value: {
			  duration: 100,
			  easing: 'ease-in',
			  delay: 0,
			  iterations: 1,
			  direction: 'normal',
			  fill: 'forwards'
			}
		},
		cardAnimationOptions: {
			type: Object,
			value: {
                    duration: 300,
   			  easing: 'ease-in',
   			  delay: 0,
   			  iterations: 1,
   			  direction: 'normal',
   			  fill: 'forwards'
			}
		},
		initalOverflow: {
			type: String
		},
		headerHeight: {
			type: Number,
			value: 70
		}
	},
	attached: function(){
		this.initalOverflow = document.body.style.overflow;
	},
	// Top level function (the only one you should call outside this component)
	toggle: function(){

		var _this = this;

		return new Promise(function(resolve, reject){
			if(_this.animating) return;
			_this.animating = true;

			document.body.style.overflow = 'hidden';
			_this._toggleContent(0)
			.then(function(){
				_this._toggleCard()
				.then(function(){
					_this._toggleContent(1)
					.then(function(){
						if(!_this.expanded) {
							document.body.style.overflow = _this.initalOverflow;
							_this.$['placeholder-content__paper-card'].style.borderRadius = '2px';
							_this.$['expanded-content__content'].style.overflow = 'hidden';
						}
						else{
							_this.$['placeholder-content__paper-card'].style.borderRadius = '0px';
						}
						_this.$['placeholder-content__header'].style.height = _this.headerHeight+'px';
						_this.animating = false;
						return resolve();
					})
				})
			})
		})

	},

	_toggleContent: function(value){
		var _this = this;
		return new Promise(function(resolve, reject){
			var target = (_this.expanded) ? _this.children['expanded-content'] : _this.children['retracted-content'];
			var reversedValue = (value) ? 0 : 1;
			if(value) target.style.display = 'flex';
			_this._promoteElement(target);
			requestAnimationFrame(function(){
				var player = target.animate(
					[
				    { opacity: reversedValue, offset: 0 },
				    { opacity: value, offset: 1 }
			    ],
			    _this.contentAnimationOptions
		    );
		    player.onfinish = _this._onContentAnimationEnd.bind(_this, target, value, resolve);
			})


		});
	},
	_onContentAnimationEnd: function(target, value, resolve){
		this._demoteElement(target);
		if(!value) target.style.display = 'none';
		else if(value && this.expanded){
			this.$['expanded-content__content'].style.overflow = 'auto';
		}
		return resolve();
	},
	_toggleCard: function(){
		var _this = this;
		return new Promise(function(resolve, reject){
			var first, last, evt;
			if(_this.expanded){
				evt = _this.RETRACTING_EVENT;
				var otherCards = _this.parentNode.querySelectorAll('expandable-card');
				var index = Array.prototype.indexOf.call(otherCards, _this);
                        if(index - 1 < 0){
                              first = _this.getBoundingClientRect();
                              _this.classList.remove('host_expanded');
      				last = _this.getBoundingClientRect();
                        }
                        else {
                              last = otherCards[(index-1)].getBoundingClientRect();
                              first = _this.getBoundingClientRect();
                              _this.classList.remove('host_expanded');
                        }

			}
			else{
				evt = _this.EXPANDING_EVENT;
				first = _this.getBoundingClientRect();
				_this.classList.add('host_expanded');
				last = _this.getBoundingClientRect();
				_this.style.zIndex = 10;
			}
			_this.fire(evt, {el: _this});
			var invertCard = _this._computeCardInterpolation(first, last, !_this.expanded);
			_this.style.transform = invertCard;
			var invertPlaceholderCard = _this._setPlaceholderCardStyle(evt, first.height / last.height);
			_this._promoteElement(_this);
			_this._promoteElement(_this.$['placeholder-content__paper-card']);
					requestAnimationFrame(function(){
						var placeholderCardTranslation = (evt === _this.EXPANDING_EVENT) ? _this.headerHeight / 2 : 0;
						var placeholderCardScaleY = (evt === _this.EXPANDING_EVENT) ?  1 - _this.headerHeight  / (last.height) : 1;

						var cardKF = [
						  { transform: invertCard },
						  { transform: 'none' }
						];

						var placeholderCardKF = [
							{ transform: invertPlaceholderCard },
							{ transform: 'translateY('+placeholderCardTranslation+'px) scaleY('+placeholderCardScaleY+')' }
						];

						var kEffects = [
						  new KeyframeEffect(_this.$['placeholder-content__paper-card'], placeholderCardKF, _this.cardAnimationOptions),
						  new KeyframeEffect(_this, cardKF, _this.cardAnimationOptions)
						];

						var group = new GroupEffect(kEffects);
						var player = document.timeline.play(group);
						player.onfinish = _this._onCardTransitionEnd.bind(_this, resolve);
					})

		});
	},
	_onCardTransitionEnd: function(resolve){
		this._demoteElement(this);
		this._demoteElement(this.$['placeholder-content__paper-card']);
		this.expanded = !this.expanded;
		if(!this.expanded) this.style.zIndex = 2;
		return resolve();
	},
	_setPlaceholderCardStyle: function(evt, ratio){
		var transform;
		if(evt === this.EXPANDING_EVENT){
			transform = 'translateY(0px)';
			this.$['placeholder-content__paper-card'].style.transform = transform;
			this.$['placeholder-content__header'].style.height = this.headerHeight;
		}
		else{
			var headerRatio = this.headerHeight / ratio;
			transform ='translateY('+(headerRatio)+'px)';
			this.$['placeholder-content__paper-card'].style.transform = transform;
			this.$['placeholder-content__header'].style.height = (headerRatio + 1)+'px';
		}

		return transform;
	},
	_computeCardInterpolation: function(first, last, expanding){
		var scaleY = first.height / last.height;
		var scaleX = first.width / last.width;

		var translateX = ( ( last.width - first.width ) / 2 + ( last.left - first.left ) ) * -1;
		var translateY = ( (last.height - first.height) / 2 + ( last.top - first.top ) ) * -1;

		return 'translateX('+translateX+'px) translateY('+translateY+'px) scaleX('+scaleX+') scaleY('+scaleY+')';
	},

	_promoteElement: function(el){
		el.style.willChange = 'transform';
	},
	_demoteElement: function(el){
		el.style.willChange = 'initial';
		el.style.transform = 'none';
	}

});
</script>
</dom-module>
